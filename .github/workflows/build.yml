name: Build LaTeX PDF - AS5113 Triet Hoc

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Diagnose
        run: |
          echo "Triggered on $GITHUB_REF@${GITHUB_SHA}"
          ls -la || true

      - name: Compile LaTeX (XeLaTeX)
        uses: xu-cheng/latex-action@v3
        with:
          root_file: main.tex
          latexmk_use_xelatex: true
          latexmk_shell_escape: true

      - name: Publish PDF to project root
        run: |
          cp main.pdf AS5113_Nhom7_ChuNghiaKhacKi.pdf
          ls -la

      - name: Upload artifact (PDF)
        uses: actions/upload-artifact@v4
        with:
          name: as5113-triet-hoc-pdf
          path: AS5113_Nhom7_ChuNghiaKhacKi.pdf

      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: latex-build-logs
          path: |
            main.log
            main.aux
            main.toc
            main.lof
            main.lot

  release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    needs: build-pdf
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog from commit history
        run: |
          set -euo pipefail
          
          LAST_TAG=""
          if git describe --tags --abbrev=0 >/dev/null 2>&1; then
            LAST_TAG=$(git describe --tags --abbrev=0)
            echo "Found last tag: ${LAST_TAG}" >&2
          else
            echo "No tags found, will include all commits" >&2
          fi
          
          {
            echo "## Changelog ($(date -u +"%Y-%m-%d %H:%M:%S") UTC)"
            echo ""
            
            if [ -n "$LAST_TAG" ]; then
              COMMIT_RANGE="${LAST_TAG}..HEAD"
              echo "Getting commits from ${LAST_TAG} to HEAD" >&2
              
              if git log "${COMMIT_RANGE}" --oneline 2>/dev/null | head -1 >/dev/null 2>&1; then
                git log "${COMMIT_RANGE}" --no-merges --pretty=format:"*   **%s** (%h)"
              else
                echo "- No new commits since ${LAST_TAG}"
              fi
            else
              echo "### All Commits (no previous release found)"
              echo ""
              git log --no-merges --pretty=format:"*   **%s** (%h)"
            fi
            
          } > release_notes.md
          
          if [ ! -s release_notes.md ] || ! grep -q "^\*" release_notes.md; then
            {
              echo "## Changelog ($(date -u +"%Y-%m-%d %H:%M:%S") UTC)"
              echo ""
              echo "### Recent Changes"
              echo ""
              git log -n 50 --no-merges --pretty=format:"*   **%s** (%h)" 2>/dev/null || echo "- No commits found."
            } > release_notes.md
          fi
          
          echo "=== Changelog Preview (first 50 lines) ==="
          head -50 release_notes.md
          echo ""
          echo "=== Total lines in changelog ==="
          wc -l release_notes.md || echo "0"
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: as5113-triet-hoc-pdf
          path: dist
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: build-${{ github.run_number }}
          name: AS5113 Nhom 7 - Chu Nghia Khac Ki (Build ${{ github.run_number }})
          body_path: release_notes.md
          files: dist/AS5113_Nhom7_ChuNghiaKhacKi.pdf
